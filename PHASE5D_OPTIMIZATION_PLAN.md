# Phase 5-D: XGBoost 適応型最適化計画

**目標**: Phase 5-B (+293.83%) をさらに改善し、+350% 以上を達成する

---

## 📊 Phase 5-B 基準性能

| メトリクス | 値 | 備考 |
|-----------|-----|------|
| **総リターン** | **+293.83%** | ✅ 最高性能 |
| **取引数** | 288 | 2年間で288回エントリー |
| **勝率** | **65.28%** | 188勝 / 100敗 |
| **最終資産** | $393,827 | $100,000 → $393,827 |
| **Sharpe比** | 未測定 | リスク調整済みリターン |
| **最大ドローダウン** | 未測定 | リスク指標 |

---

## 🎯 Phase 5-D 最適化戦略

### 1️⃣ ハイパーパラメータ最適化 (Grid Search)

**現在のXGBoostパラメータ**:
```python
n_estimators=100
max_depth=7
learning_rate=0.05
subsample=0.8
colsample_bytree=0.8
```

**最適化スペース**:
```
Grid Parameters:
├─ n_estimators: [50, 100, 150, 200] (木の数)
├─ max_depth: [5, 6, 7, 8, 9] (木の深さ)
├─ learning_rate: [0.01, 0.03, 0.05, 0.07, 0.1] (学習率)
├─ subsample: [0.6, 0.7, 0.8, 0.9] (サブサンプリング率)
├─ colsample_bytree: [0.6, 0.7, 0.8, 0.9] (特徴サブサンプリング率)
└─ gamma: [0, 0.1, 0.5, 1.0] (正則化項)

Total Combinations: 4 × 5 × 5 × 4 × 4 × 4 = 3,200 variations
```

**探索戦略**:
- ✅ ランダム探索: 500パターンサンプリング (全3,200から)
- ✅ 検証セット AUC を最適化
- ✅ バックテスト性能で最終確認

---

### 2️⃣ 特徴選択・エンジニアリング最適化

**現在の特徴セット**: 40特徴
```
OHLCV + 技術指標:
├─ 価格 (5): Open, High, Low, Close, Volume
├─ 移動平均 (6): ma5, ma20, ma50, slope×3
├─ モメンタム (3): RSI14, MACD, Signal
├─ ボラティリティ (7): BB, width, vol5/10/20
├─ 価格特性 (4): hl_ratio, price_range, lag1-5, autocorr
├─ 相関 (2): Close-MA相関
└─ 曜日ダミー (5): Mon-Fri
```

**最適化方針**:
1. **特徴重要度分析**
   - XGBoost の feature_importances_ から寄与度を分析
   - 寄与度 < 1% の特徴を検証対象に
   - 1-3個削除/追加で影響を測定

2. **新規特徴の実装**
   ```python
   新規候補:
   ├─ パーセンタイル: price vs 20/50/100MA (位置関係)
   ├─ ボラティリティ比率: vol_now / vol_MA (相対的ボラ)
   ├─ 動的サポート/レジスタンス: pivot points
   ├─ 時間的なパターン: session times (NY/LDN/TYO)
   └─ 値幅統計: 直近 N 期間の値幅の標準偏差
   ```

3. **特徴スケーリング最適化**
   - 正規化: MinMaxScaler vs StandardScaler
   - ロバスト性: RobustScaler (外れ値に強い)

---

### 3️⃣ トレード条件最適化

**現在の設定**:
```python
TP (Take Profit):  +0.60% (動的, ボラティリティ適応)
SL (Stop Loss):    -0.30% (動的, ボラティリティ適応)
Entry Threshold:   Confidence >= 0.55
```

**最適化項目**:

1. **TP/SL の微調整**
   ```
   Grid:
   ├─ TP Base: [0.50%, 0.60%, 0.70%, 0.80%]
   ├─ SL Base: [0.20%, 0.25%, 0.30%, 0.35%]
   ├─ Volatility Multiplier: [0.5x, 0.75x, 1.0x, 1.25x, 1.5x]
   └─ Time-based adjustment: [有効/無効]

   Combinations: 4 × 4 × 5 × 2 = 160 variations
   ```

2. **エントリー信頼度閾値**
   ```
   Current: 0.55
   Test Range: [0.45, 0.50, 0.55, 0.60, 0.65, 0.70]

   Trade-off:
   └─ 閾値↓ → 取引数↑, 勝率↓
   └─ 閾値↑ → 取引数↓, 勝率↑
   ```

3. **ポジションサイジング最適化**
   ```
   Current: Fixed (すべてのトレードで同じ)
   New Options:
   ├─ Fixed Risk: Account × 1% per trade
   ├─ Kelly Criterion: f* = (p*b - q) / b
   ├─ Volatility-Adjusted: Position ∝ 1/volatility
   └─ Confidence-Weighted: Position ∝ model_confidence
   ```

---

### 4️⃣ ドローダウン管理戦略

**リスク制御メカニズム**:
1. **ダイナミックストップロス**
   - トレイリングストップ (戦勝時にSLを引き上げる)
   - タイムベース・ストップ (N分後にクローズ)

2. **エクイティ保護**
   - 1日の最大損失制限: Account × 2%/day
   - 連続損失制限: 3連敗でスキップ

3. **時間フィルタ**
   - ボラティリティが高い時間帯をスキップ (NY開場前30分など)
   - 経済指標発表の±30分をスキップ

---

## 📈 Phase 5-D 実装スケジュール

```
Stage 1: ハイパーパラメータ最適化 (約2時間)
├─ Random Grid Search: 500パターン
├─ 各パターンを検証セット (20%) で評価
├─ 上位5パターンを抽出
└─ 結果: 最適パラメータ組み合わせ

Stage 2: 特徴エンジニアリング (約1時間)
├─ Feature Importance 分析
├─ 不要な特徴削除テスト (1-3個)
├─ 新規特徴追加テスト (1-2個)
└─ 結果: 最適特徴セット

Stage 3: トレード条件最適化 (約3時間)
├─ TP/SL Grid Search (160パターン)
├─ エントリー閾値テスト (6パターン)
├─ ポジションサイジング比較
└─ 結果: 最適トレード設定

Stage 4: ドローダウン管理テスト (約1時間)
├─ トレイリングストップ効果測定
├─ 時間フィルタの検証
└─ 結果: リスク調整済みパフォーマンス

Stage 5: 最終バックテスト & レポート (約1時間)
├─ 全最適化を統合したバックテスト実行
├─ Phase 5-Bとの比較分析
├─ 結果ドキュメント生成
└─ 結果: Phase 5-D 最終成果
```

---

## 🎁 期待される改善

**保守的な予測**:
- TP/SL最適化: +15-25%改善
- ハイパーパラメータ: +5-10%改善
- 特徴エンジニアリング: +3-5%改善
- リスク管理: -20%ドローダウン削減

**目標値**: +350% 以上 (+56% 改善)

---

## ⚠️ リスクと制約

1. **過学習 (Overfitting)**
   - 検証セット で過最適化される可能性
   - → Walk-forward analysis でテスト必要

2. **実行時間**
   - 3,200パターン × 17秒 = 55,000秒 (15時間)
   - → ランダム探索で500パターンに削減

3. **市場変動性**
   - 過去2年の性能が将来も再現するとは限定なし
   - → 異なる時間期間でクロスバリデーション必要

---

## 📋 実装リスト

```
□ Stage 1: ハイパーパラメータ最適化スクリプト作成
□ Stage 2: Feature Importance 分析スクリプト作成
□ Stage 3: TP/SL Grid Search スクリプト作成
□ Stage 4: ドローダウン管理ロジック実装
□ Stage 5: 統合バックテストと最終レポート生成
```

---

## 🚀 次のステップ

**実装開始**: Stage 1 から開始予定

---

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>
