# Step 12: パラメータ最適化分析と戦略調整

**実行日**: 2025-11-24
**フェーズ**: Phase 5 - パラメータ最適化
**ステータス**: ✅ **分析・最適化提案完了** → 実装推奨フェーズへ

---

## 📋 エグゼクティブサマリー

ハイブリッド戦略（季節性 + XGBoost）の現在のパフォーマンス（+4.85%）を分析し、目標の+65%～75%に到達するための包括的な最適化提案を構築しました。

**主要課題**:
- ✅ XGBoost: 593個の買いシグナル → 22取引 (3.7%)のみ実行
- ✅ 信号フィルタリング効率: 96.3%のシグナルが実行されていない
- ✅ パフォーマンスギャップ: -57.61pp vs Step 10 (+62.46%)

---

## 🔍 現在のパラメータセット分析

### 1. XGBoost閾値 = 0.50 (現在)

**役割**: XGBoストの確信度を確認し、買いシグナルを選別

**パフォーマンス**:
```
閾値 = 0.50 の場合:
  - 買いシグナル: 593個
  - 実際の取引: 22個
  - フィルター率: 96.3%
  - 勝率: 59.09%
  - 総リターン: +4.85%
```

**最適化提案**:
| 閾値 | 期待効果 | トレードオフ |
|------|---------|-----------|
| **0.45** | シグナル増加, 取引機会増 | 精度低下の可能性 |
| **0.50** | バランス型 (現在) | 現在の制約継続 |
| **0.55** | シグナル削減, 精度重視 | 機会喪失 |
| **0.60** | 高精度のみ | 過度に保守的 |

**推奨**: **0.45に調整** → シグナル増加で取引機会を拡大

---

### 2. 季節性重み係数 = (0.30, 0.70) [週次, 月次]

**役割**: 季節パターンの重要度を加重平均で統合

```
current = 0.30 × weekly_score + 0.70 × monthly_score
          = 強い月別パターン依存

weekly_signal範囲:    [-0.1 to +0.1] (20% range)
monthly_signal範囲:   [-0.2 to +0.2] (40% range)
→ 月別パターンの影響が2倍大きい
```

**最適化分析**:

#### パターンA: (0.25, 0.75) - 月別強調
```
impact = 0.25 × [-0.1, +0.1] + 0.75 × [-0.2, +0.2]
       = [-0.175, +0.175]

効果: 月別の強い季節性をより活用
  ✓ June/October: +0.1-+0.2 bias強化
  ✗ December: -0.2 bias強化 (悪い月を避けにくい)
```

#### パターンB: (0.30, 0.70) - バランス (現在)
```
影響: 月別70% + 週次30%
結果: 適切なバランス
```

#### パターンC: (0.35, 0.65) - 週別強調
```
impact = 0.35 × [-0.1, +0.1] + 0.65 × [-0.2, +0.2]
       = [-0.165, +0.165]

効果: 週別パターンにより応答性向上
  ✓ Monday/Tuesday: +0.1 bias活用
  ✓ 日次の変動に素早く対応
```

**推奨**: **テスト順序**
1. (0.35, 0.65) - 週別対応力向上
2. (0.30, 0.70) - 現状維持
3. (0.25, 0.75) - 月別強調

---

### 3. 信号融合閾値 = (0.60, 0.40) [買い, 売り]

**役割**: ハイブリッドスコアで最終的な買い/売り判定を決定

```
weighted_probability = xgb_prob × (0.5 + 0.5 × seasonality_score)

信号ロジック:
  if weighted_prob ≥ 0.60 → BUY
  elif weighted_prob < 0.40 → SELL
  else → HOLD
```

**現在の動作分析**:
```
入力範囲分析:
  xgb_prob:              [0.0, 1.0]
  seasonality_score:     [0.0, 1.0]

weighted = xgb_prob × (0.5 + 0.5 × season)
         = xgb_prob × [0.5 to 1.0]

例:
  xgb=0.60, season=0.0 → weight=0.30 (SELL)
  xgb=0.60, season=1.0 → weight=0.60 (BUY)
  xgb=0.70, season=0.5 → weight=0.53 (HOLD)
```

**最適化提案**:

| 設定 | BUY閾値 | SELL閾値 | 期待効果 |
|------|---------|---------|---------|
| **厳密** | 0.65 | 0.35 | シグナル削減, 精度向上 |
| **バランス** | 0.60 | 0.40 | 現在 |
| **積極** | 0.55 | 0.45 | シグナル増加, リスク増加 |

**推奨**: **段階的テスト**
1. (0.60, 0.40) - ベースラインで検証
2. (0.55, 0.45) - シグナル増加テスト
3. (0.65, 0.35) - 精度重視テスト

---

## 📊 パラメータ最適化グリッド提案

### Grid Search計画 (36パラメータ組み合わせ)

```
次元1: XGBoost閾値
  [0.45, 0.50, 0.55, 0.60]

次元2: 季節性重み
  [(0.25,0.75), (0.30,0.70), (0.35,0.65)]

次元3: 信号閾値
  [(0.55,0.45), (0.60,0.40), (0.65,0.35)]

総計: 4 × 3 × 3 = 36組み合わせ
```

### 実装順序 (優先度ベース)

**Phase 5-1: HighImpact最適化 (9組み合わせ)**
```
XGBoost ∈ [0.45, 0.50, 0.55]  (← 信号数への直接影響)
Seasonality = (0.30, 0.70)    (← 現状維持で検証)
Signal ∈ [(0.55,0.45), (0.60,0.40)]
```

**Phase 5-2: Seasonalityファイン調整 (9組み合わせ)**
```
XGBoost = 0.50              (← Phase 5-1から最適値)
Seasonality = all 3 options  (← 詳細な季節パターンテスト)
Signal = (0.60, 0.40)       (← Phase 5-1から最適値)
```

**Phase 5-3: 精密調整 (残り組み合わせ)**
```
全36組み合わせの詳細比較
最上位3組み合わせの深掘り分析
```

---

## 🎯 最適化の成功基準

### Phase 6採用判定基準

| 指標 | 目標値 | 現在値 | ギャップ |
|------|--------|---------|---------|
| **総リターン** | > +65% | +4.85% | -60.15pp ⚠️ |
| **取引数** | 150-200 | 22 | -128 ~ -178 ⚠️ |
| **勝率** | ≥ 62% | 59.09% | -2.91pp ⚠️ |
| **Sharpe比** | ≥ 6.5 | ~0.6 | -5.9 ⚠️ |
| **最大DD** | ≤ -1.5% | -1.11% | +0.39pp ✅ |

### 合格ラインの根拠

**+65%目標の理由**:
- Step 10: +62.46% (季節性のみ)
- Step 12: +65% = Step 10 + 2.54pp (統合効果)
- XGBoostが季節性に追加価値をもたらす証拠

**150-200取引目標の理由**:
- 現在: 22取引 (3年, 40%信号フィルター)
- 月平均: 0.6取引/月 (不充分)
- 理想: 4-7取引/月 (年50-84取引, 3年150-250)

**62%勝率目標の理由**:
- XGBoost単独: 59.09%
- 季節性フィルタ効果: +2-5pp
- 組み合わせ相乗効果による改善

---

## 🔧 シグナルフィルター問題の根本原因分析

### 問題: 593 → 22 (3.7%実行率)

#### 仮説1: ポジション管理ロジック
```
メカニズム:
  1. BUYシグナル発生
  2. ポジションオープン (entry_price記録)
  3. 次のシグナルでも position is not None
     → 新規エントリーをスキップ
  4. TP/SLの何れか先に到達
  5. ポジションクローズ
  6. 次のシグナルまで待機

結果:
  - 1つのBUYシグナル = 1つの取引
  - 複数のシグナル = 最初のみ実行, 後続は無視
  - パイプライン効果: 平均2-3日/取引
```

#### 仮説2: 季節性スコア分布
```
計算式:
  seasonality_score = 0.3 × weekly + 0.7 × monthly

範囲分析:
  最小: 0.3 × 0.4 + 0.7 × 0.3 = 0.33
  最大: 0.3 × 0.6 + 0.7 × 0.7 = 0.67

結果:
  信号融合: weighted = xgb × (0.5 + 0.5 × season)
          = xgb × [0.5, 0.85]

制約: xgb=0.50以上でも
      season=0.33 → weight=0.415 (HOLD)
      season=0.67 → weight=0.835 (BUY)
```

#### 仮説3: XGBoost予測品質
```
現在のF1: 0.6476
精度: 49.32%
混同行列:
  TN: 4,  FP: 71
  FN: 3,  TP: 68

実際の陽性: 3+68=71 (out of 146)
検出率: 68/71=95.8%
偽陽性率: 71/(4+71)=94.7%

結果: 高い偽陽性率 (正シグナルの多くがノイズ)
```

### 根本的な解決提案

#### アプローチA: 多重時間軸統合
```
現在: 1D candles
提案:
  - 1D primary
  - 4H confirmation
  - 1H entry timing

効果: ノイズ削減, 実行可能シグナル増
```

#### アプローチB: シグナル品質スコアリング
```
現在: binary (BUY/SELL/HOLD)
提案:
  - Score = [0.0, 1.0]
  - 信頼度 > 0.7 → 即座に実行
  - 信頼度 0.5-0.7 → 確認待ち
  - 信頼度 < 0.5 → スキップ

効果: 低品質シグナル排除
```

#### アプローチC: ポジション集約戦略
```
現在: 1トレード/シグナル
提案:
  - 同日シグナル集約
  - 複数入場をスケール入場に
  - コンフルエンス検出

効果: 機会集約, 実行数保持
```

---

## 📈 期待パフォーマンス改善シナリオ

### シナリオ1: 保守的改善 (パラメータ最適化のみ)
```
介入: XGBoost 0.50→0.45, Signal (0.60,0.40)→(0.55,0.45)

期待値:
  - 取引数: 22 → 35-40 (+60-80%)
  - 総リターン: +4.85% → +12-18%
  - 勝率: 59% → 60-61%

実現確率: 70-80%
実装難度: 低 (パラメータ調整のみ)
```

### シナリオ2: 適度な改善 (信号品質向上)
```
介入:
  - パラメータ最適化
  - 多重時間軸 (4Hサポート)
  - 信号信頼度スコアリング

期待値:
  - 取引数: 22 → 80-120 (+260-450%)
  - 総リターン: +4.85% → +35-45%
  - 勝率: 59% → 62-64%

実現確率: 50-60%
実装難度: 中 (モジュール追加)
```

### シナリオ3: 積極的改善 (完全統合)
```
介入:
  - 多重時間軸統合
  - アンサンブル学習 (XGB+Random Forest)
  - ポジション集約
  - 動的ポジション調整

期待値:
  - 取引数: 22 → 150-200
  - 総リターン: +4.85% → +65-80%
  - 勝率: 59% → 63-65%
  - Sharpe: 0.6 → 6.5+

実現確率: 30-40%
実装難度: 高 (大幅な再設計)
```

---

## 💡 推奨実装ロードマップ

### Phase 5-A: 高速パラメータ最適化 (1日)
```
目標: 最適パラメータセット特定

実施内容:
  1. Grid Search実行 (36組み合わせ)
  2. 上位3組み合わせ特定
  3. Sharpe比とMax DD検証
  4. 推奨パラメータセット選定

期待結果: +12-18%への改善見通し
```

### Phase 5-B: 信号品質向上 (2-3日)
```
目標: シグナルフィルター改善

実施内容:
  1. 4H時間軸データ追加
  2. マルチタイムフレーム確認ロジック
  3. 信号信頼度スコア計算
  4. 閾値ベースフィルタリング
  5. バックテスト検証

期待結果: +35-45%への改善見通し
```

### Phase 5-C: アンサンブル統合 (3-5日)
```
目標: 予測精度向上

実施内容:
  1. Random Forest/LightGBMモデル追加
  2. アンサンブル投票メカニズム
  3. 予測スコア統合
  4. ウェイト最適化
  5. 包括的バックテスト

期待結果: +65-80%への改善見通し
```

---

## 🏁 結論と次ステップ

### 現在の状態
- ✅ Step 12実装完了
- ✅ 基本的なハイブリッド戦略動作確認
- ✅ パフォーマンスギャップ特定 (-57.61pp)
- ✅ 根本原因分析完了
- ✅ 最適化パス明確化

### 決定フロー

**優先度1: 高速パラメータ最適化 (推奨)**
```
実施: Phase 5-A
期待: +12-18%への即座の改善
難度: 低
リスク: 低
→ 実装推奨
```

**優先度2: 信号品質向上 (推奨)**
```
実施: Phase 5-B
期待: +35-45%への改善
難度: 中
リスク: 中
→ Phase 5-Aの後に段階的実装推奨
```

**優先度3: アンサンブル統合 (オプション)**
```
実施: Phase 5-C
期待: +65-80%への改善
難度: 高
リスク: 高
→ 需要に応じて実装を検討
```

### 行動計画

**即座に実施すべき (今週)**:
1. ✅ Grid Searchスクリプト実装
2. ⏳ 36パラメータ組み合わせテスト
3. ⏳ 最適パラメータセット選定
4. ⏳ 改善版のバックテスト実行

**並行して検討 (来週)**:
1. 4H時間軸データの追加
2. マルチタイムフレーム確認ロジック設計
3. アンサンブル学習の可能性評価

---

**作成日**: 2025-11-24
**フェーズ**: Phase 5 - パラメータ最適化分析
**次のステップ**: Grid Search実行 → 最適パラメータ採用判定 → Phase 6 (最終採用判定)
